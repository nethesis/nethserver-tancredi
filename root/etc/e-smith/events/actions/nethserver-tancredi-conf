#!/bin/bash

root_db_pwd=$(perl -e "use NethServer::Password; print NethServer::Password::store('mysql')")
db_pwd=$(perl -e "use NethServer::Password; print NethServer::Password::store('TancrediDBPass')")

mysql -u root -p$root_db_pwd <<EOF
USE mysql;

GRANT SELECT on asterisk.ampusers TO 'tancredi'@'localhost' identified by '$db_pwd';

FLUSH privileges;
EOF

# set default.ini on first install
dst_file="/var/lib/tancredi/data/scopes/defaults.ini"

if [[ ! -f ${dst_file} ]]; then
    echo "NOTICE: $0 initializing ${dst_file}"
    /bin/cp -v /usr/share/tancredi/data/scopes/defaults.ini ${dst_file}

    # Add variable for UI first configuration
    echo 'ui_first_config = "1"' >> ${dst_file}

    # Remove variables if they exists
    sed -i '/^timezone = /d' ${dst_file}
    sed -i '/^language = /d' ${dst_file}
    sed -i '/^tonezone = /d' ${dst_file}

    # Add defaults
    echo 'timezone = "Europe/Rome"' >> ${dst_file}
    echo 'language = "it"' >> ${dst_file}
    echo 'tonezone = "it"' >> ${dst_file}
    echo 'hostname = "'$(hostname)'"' >> ${dst_file}
    echo 'provisioning_url_scheme = "https"' >> ${dst_file}

    # Set default admin and user passwords
    echo 'adminpw = "'$(head /dev/urandom | tr -dc a-z0-9 | head -c 10)'"' >> ${dst_file}
    echo 'userpw = "'$(head /dev/urandom | tr -dc a-z | head -c 6)'"' >> ${dst_file}
fi

